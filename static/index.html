<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Language To Text Conversion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255, 255, 255, 0.06);
      --text: #e5e7eb;
      --accent: #7dd3fc;
      --border: rgba(255, 255, 255, 0.12);
      --muted: #94a3b8;
      --btn-bg: rgba(255,255,255,0.04);
      --btn-border: rgba(255, 255, 255, 0.16);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Courier Prime', monospace;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      backdrop-filter: blur(14px);
    }
    h1 {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 520px 440px 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      backdrop-filter: blur(14px);
    }
    .video-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .video-box {
      position: relative;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      height: 360px;
    }
    video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      background: var(--btn-bg);
      color: #fff;
      border: 1px solid var(--btn-border);
      border-radius: 8px;
      padding: 10px 16px;
      font-family: 'Courier Prime', monospace;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    button:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    button.primary {
      background: var(--accent);
      color: #0b1220;
      border-color: var(--accent);
    }
    button.primary:hover {
      background: #93ddfd;
    }
    .skeleton-panel {
      height: 440px;
    }
    .skeleton-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .skeleton-box img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .info-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .info-label {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
    }
    .info-value {
      flex: 1;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      min-height: 50px;
      display: flex;
      align-items: center;
    }
    .sentence-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sentence-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 18px;
      color: #fff;
      min-height: 100px;
      word-wrap: break-word;
      line-height: 1.6;
    }
    .suggestions-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .suggestions-label {
      font-size: 18px;
      font-weight: 700;
      color: #ff6b6b;
    }
    .suggestions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .suggestion-btn {
      background: rgba(255,255,255,0.08);
      color: #fff;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      text-align: center;
      word-wrap: break-word;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
    }
    .action-buttons button {
      flex: 1;
      font-size: 16px;
      padding: 14px;
    }
    .status-bar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      backdrop-filter: blur(14px);
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }
    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sign Language To Text Conversion</h1>
    </header>

    <div class="main-grid">
      <div class="video-panel panel">
        <div class="video-box">
          <video id="video" autoplay playsinline muted></video>
        </div>
        <div class="controls">
          <button id="start" class="primary">Start Camera</button>
          <button id="snap">Send Frame</button>
          <button id="loop">Auto Capture (2 fps)</button>
        </div>
      </div>

      <div class="skeleton-panel panel">
        <div class="skeleton-box" id="skeletonBox">
          <span style="color: var(--muted);">Hand skeleton will appear here</span>
        </div>
      </div>

      <div class="info-panel panel">
        <div class="info-row">
          <span class="info-label">Character:</span>
          <div class="info-value" id="char">–</div>
        </div>
        
        <div class="sentence-row">
          <span class="info-label">Sentence:</span>
          <div class="sentence-box" id="sentence"></div>
        </div>

        <div class="suggestions-section">
          <span class="suggestions-label">Suggestions:</span>
          <div class="suggestions-grid" id="suggestions"></div>
        </div>

        <div class="action-buttons">
          <button id="speak" class="primary">Speak</button>
          <button id="clear">Clear</button>
        </div>
      </div>
    </div>

    <div class="status-bar" id="status">Ready to start</div>
  </div>

  <script>
    const video = document.getElementById('video');
    const charEl = document.getElementById('char');
    const sentenceEl = document.getElementById('sentence');
    const suggestionsEl = document.getElementById('suggestions');
    const skeletonBox = document.getElementById('skeletonBox');
    const statusEl = document.getElementById('status');
    let stream = null;
    let loopId = null;
    let sessionId = localStorage.getItem('session_id') || null;

    function updateStatus(msg) {
      statusEl.textContent = msg;
    }

    async function startCamera() {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = stream;
        updateStatus('Camera started. Ready to capture.');
      } catch (err) {
        updateStatus('Camera error: ' + err.message);
      }
    }

    function captureFrame() {
      if (!video.videoWidth) return null;
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    async function sendFrame() {
      const dataUrl = captureFrame();
      if (!dataUrl) {
        updateStatus('No frame ready yet.');
        return;
      }
      updateStatus('Predicting…');
      try {
        const res = await fetch('/api/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl, session_id: sessionId })
        });
        const body = await res.json();
        if (res.ok) {
          charEl.textContent = body.char || '–';
          sessionId = body.session_id || sessionId;
          localStorage.setItem('session_id', sessionId);
          sentenceEl.textContent = body.sentence || '';
          
          // Show skeleton if available
          if (body.skeleton) {
            skeletonBox.innerHTML = `<img src="${body.skeleton}" alt="Hand Skeleton" />`;
          }
          
          renderSuggestions(body.suggestions || []);
          updateStatus('Prediction complete');
        } else {
          updateStatus('Error: ' + (body.error || res.status));
        }
      } catch (err) {
        updateStatus('Network error: ' + err.message);
      }
    }

    function renderSuggestions(list) {
      suggestionsEl.innerHTML = '';
      if (list.length === 0) {
        for (let i = 0; i < 4; i++) {
          const btn = document.createElement('button');
          btn.className = 'suggestion-btn';
          btn.textContent = '';
          btn.disabled = true;
          suggestionsEl.appendChild(btn);
        }
        return;
      }
      list.forEach(word => {
        const btn = document.createElement('button');
        btn.className = 'suggestion-btn';
        btn.textContent = word;
        btn.onclick = async () => {
          // Replace last word in sentence with suggestion
          let currentSentence = sentenceEl.textContent;
          const words = currentSentence.trim().split(/\\s+/);
          if (words.length > 0) {
            words[words.length - 1] = word.toUpperCase();
            const newSentence = words.join(' ');
            sentenceEl.textContent = newSentence;
            // Update on server
            try {
              await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
              });
              const res2 = await fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  image: captureFrame(),
                  session_id: sessionId,
                  override_sentence: newSentence
                })
              });
            } catch(e) {
              console.error(e);
            }
          }
          updateStatus('Applied suggestion: ' + word);
        };
        suggestionsEl.appendChild(btn);
      });
      // Fill remaining slots
      for (let i = list.length; i < 4; i++) {
        const btn = document.createElement('button');
        btn.className = 'suggestion-btn';
        btn.textContent = '';
        btn.disabled = true;
        suggestionsEl.appendChild(btn);
      }
    }

    document.getElementById('start').onclick = startCamera;
    document.getElementById('snap').onclick = sendFrame;
    document.getElementById('loop').onclick = () => {
      if (loopId) {
        clearInterval(loopId);
        loopId = null;
        updateStatus('Auto capture stopped');
        return;
      }
      updateStatus('Auto capture started (2 fps)');
      loopId = setInterval(sendFrame, 500);
    };
    
    document.getElementById('clear').onclick = async () => {
      try {
        const res = await fetch('/api/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        const body = await res.json();
        sessionId = body.session_id || sessionId;
        localStorage.setItem('session_id', sessionId);
        sentenceEl.textContent = '';
        charEl.textContent = '–';
        renderSuggestions([]);
        updateStatus('Cleared sentence');
      } catch (err) {
        updateStatus('Clear error: ' + err.message);
      }
    };

    document.getElementById('speak').onclick = async () => {
      const text = sentenceEl.textContent.trim();
      if (!text) {
        updateStatus('No text to speak');
        return;
      }
      updateStatus('Generating speech...');
      try {
        const res = await fetch('/api/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const body = await res.json();
        if (res.ok && body.audio) {
          const audio = new Audio('data:audio/mp3;base64,' + body.audio);
          audio.play();
          updateStatus('Speaking...');
          audio.onended = () => updateStatus('Speech complete');
        } else {
          updateStatus('Speak error: ' + (body.error || 'unknown'));
        }
      } catch (err) {
        updateStatus('Speak error: ' + err.message);
      }
    };

    // Initialize
    renderSuggestions([]);
  </script>
</body>
</html>
